<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Brand√£o Im√≥veis</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="js/supabase.js"></script>
  <link rel="icon" type="image/png" href="images/favicon.png">
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <header>
    <h1>Brand√£o Im√≥veis</h1>
  </header>

  <main>
    <section id="filtros">
      <!-- Estado -->
      <select id="estado">
        <option value="">Estado</option>
      </select>

      <!-- Cidade -->
      <select id="cidade" disabled>
        <option value="">Cidade</option>
      </select>

      <!-- Tipo -->
      <select id="tipo">
        <option value="">Tipo</option>
        <option value="Casa">Casa</option>
        <option value="Apartamento">Apartamento</option>
      </select>

      <!-- Disponibilidade -->
      <select id="disponibilidade">
        <option value="">Disponibilidade</option>
        <option value="Alugar">Apenas alugar</option>
        <option value="Comprar">Apenas comprar</option>
      </select>

     <label for="preco">Faixa de pre√ßo:</label>
<select id="preco" onchange="togglePrecoCustom(this.value)">
  <option value="">Selecione a faixa</option>
  <option value="0-200000">At√© R$ 200 mil</option>
  <option value="200000-400000">R$ 200 mil a R$ 400 mil</option>
  <option value="400000-600000">R$ 400 mil a R$ 600 mil</option>
  <option value="600000-800000">R$ 600 mil a R$ 800 mil</option>
  <option value="800000-1000000">R$ 800 mil a R$ 1 milh√£o</option>
  <option value="custom">Outro valor...</option>
</select>

<input type="text" id="preco-custom" placeholder="Digite a faixa (ex: 300000-700000)" style="display:none;" />


      <!-- Quartos -->
      <select id="quartos">
        <option value="">Quartos</option>
        <option value="1">1+</option>
        <option value="2">2+</option>
        <option value="3">3+</option>
        <option value="4">4+</option>
      </select>

      <!-- Banheiros -->
      <select id="banheiros">
        <option value="">Banheiros</option>
        <option value="1">1+</option>
        <option value="2">2+</option>
        <option value="3">3+</option>
        <option value="4">4+</option>
      </select>

      <div style="display:flex; gap:10px; margin-top:10px;">
        <button id="filtrar">Filtrar</button>
        <button id="limpar">Limpar filtros</button>
      </div>
    </section>
    
    <div id="lista-imoveis" class="grid"></div>
  </main>

  <script>
  const estadoSelect = document.getElementById("estado");
  const cidadeSelect = document.getElementById("cidade");

      // üîπ Fun√ß√£o para mostrar ou esconder o campo de pre√ßo personalizado
  function togglePrecoCustom(value) {
    const input = document.getElementById("preco-custom");
    input.style.display = value === "custom" ? "block" : "none";
  }

  // ‚úÖ 1. Carrega lista de estados diretamente do Supabase
  async function carregarEstados() {
    const { data, error } = await supabase.from("imoveis").select("estado");
    if (error) {
      console.error("Erro ao buscar estados:", error);
      return;
    }

    // Filtra valores √∫nicos
    const estados = [...new Set(data.map(item => item.estado).filter(Boolean))];
    estados.sort();

    estadoSelect.innerHTML = `<option value="">Estado</option>`;
    estados.forEach(estado => {
      const opt = document.createElement("option");
      opt.value = estado;
      opt.textContent = estado;
      estadoSelect.appendChild(opt);
    });
  }

  // ‚úÖ 2. Quando o estado muda, carrega as cidades correspondentes
  estadoSelect.addEventListener("change", async () => {
    const estado = estadoSelect.value;
    cidadeSelect.innerHTML = `<option value="">Cidade</option>`;
    cidadeSelect.disabled = true;

    if (!estado) return;

    const { data, error } = await supabase
      .from("imoveis")
      .select("cidade")
      .eq("estado", estado);

    if (error) {
      console.error("Erro ao buscar cidades:", error);
      return;
    }

    const cidades = [...new Set(data.map(item => item.cidade).filter(Boolean))];
    cidades.sort();

    cidadeSelect.disabled = false;
    cidades.forEach(cidade => {
      const opt = document.createElement("option");
      opt.value = cidade;
      opt.textContent = cidade;
      cidadeSelect.appendChild(opt);
    });
  });

  // ‚úÖ 3. Fun√ß√£o principal para buscar im√≥veis com filtros
  async function carregarImoveis(filtros = {}) {
    let query = supabase.from("imoveis").select("*");

    if (filtros.estado) query = query.eq("estado", filtros.estado);
    if (filtros.cidade) query = query.eq("cidade", filtros.cidade);
    if (filtros.tipo) query = query.eq("tipo", filtros.tipo);
    if (filtros.disponibilidade) query = query.eq("disponibilidade", filtros.disponibilidade);
    if (filtros.preco) {
      const [min, max] = filtros.preco.split("-").map(Number);
      query = query.gte("preco", min).lte("preco", max);
    }
    if (filtros.quartos) query = query.gte("quartos", filtros.quartos);
    if (filtros.banheiros) query = query.gte("banheiros", filtros.banheiros);

    const { data, error } = await query;
    if (error) {
      console.error(error);
      return;
    }

    const container = document.getElementById("lista-imoveis");
    container.innerHTML = "";

    if (data.length === 0) {
      container.innerHTML = `<p style="text-align:center;">Nenhum im√≥vel encontrado üòï</p>`;
      return;
    }

    data.forEach(imovel => {
      container.innerHTML += `
        <div class="card">
          <img src="${imovel.imagem_url || 'images/default.jpg'}" alt="${imovel.titulo}" />
          <h2>${imovel.titulo}</h2>
          <p>${imovel.tipo} ‚Ä¢ ${imovel.quartos} quartos ‚Ä¢ ${imovel.area_m2}m¬≤</p>
          <p>${imovel.bairro} - ${imovel.cidade}</p>
          <strong>R$ ${Number(imovel.preco).toLocaleString('pt-BR')}</strong>
          <a href="detalhes.html?id=${imovel.id}" class="botao">Ver mais detalhes</a>
        </div>
      `;
    });
  }

  // ‚úÖ 4. Bot√£o de filtro
  document.getElementById("filtrar").addEventListener("click", () => {
    const filtros = {
      estado: document.getElementById("estado").value,
      cidade: document.getElementById("cidade").value,
      tipo: document.getElementById("tipo").value,
      disponibilidade: document.getElementById("disponibilidade").value,
      preco: document.getElementById("preco").value,
      quartos: document.getElementById("quartos").value,
      banheiros: document.getElementById("banheiros").value,
    };
    carregarImoveis(filtros);
  });

  // ‚úÖ 5. Bot√£o de limpar filtros
  document.getElementById("limpar").addEventListener("click", () => {
    document.querySelectorAll("#filtros select").forEach(sel => sel.value = "");
    cidadeSelect.disabled = true;
    carregarImoveis(); // recarrega todos os im√≥veis
  });

  // ‚úÖ 6. Inicializa√ß√£o autom√°tica
  carregarEstados();
  carregarImoveis();
  </script>
</body>
</html>
