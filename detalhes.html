<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Detalhes do Im√≥vel | Gisele Brand√£o Im√≥veis</title>
  <link rel="icon" type="image/png" href="images/favicon.png">
  <link rel="stylesheet" href="CSS/detalhes.css">

  <!-- Supabase -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"

    const supabaseUrl = "https://xgknxgixeoptrgniiwiq.supabase.co"     // üîπ troque pelo seu
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhna254Z2l4ZW9wdHJnbmlpd2lxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MzIwOTksImV4cCI6MjA3NjMwODA5OX0.NeJ8_ezbWEpqJzYxxZ6fZtOWrOt0rbmooWosCvxmoeI"                      // üîπ troque pela sua anon key
    const supabase = createClient(supabaseUrl, supabaseKey)

  async function carregarDetalhes() {
  const params = new URLSearchParams(window.location.search);
  const id = params.get("id");
  const conteudo = document.getElementById("conteudo");

  if (!id) {
    conteudo.innerHTML = "<p>Im√≥vel n√£o encontrado.</p>";
    return;
  }

  const { data: imovel, error } = await supabase
    .from("imoveis")
    .select("*")
    .eq("id", id)
    .single();

  if (error || !imovel) {
    console.error("Erro ao carregar im√≥vel:", error);
    conteudo.innerHTML = "<p>Erro ao carregar im√≥vel. Veja console.</p>";
    return;
  }

  // normaliza campo imagens (pode ser text[] ou JSON string)
  let imagens = [];
  if (Array.isArray(imovel.imagens) && imovel.imagens.length) {
    imagens = imovel.imagens;
  } else if (typeof imovel.imagens === "string" && imovel.imagens.trim()) {
    // tenta parsear caso seja string JSON
    try {
      const parsed = JSON.parse(imovel.imagens);
      if (Array.isArray(parsed)) imagens = parsed;
    } catch (e) {
      // se n√£o for JSON, n√£o faz nada
    }
  }
  // fallback para imagem √∫nica
  if (imagens.length === 0 && imovel.imagem_url) {
    imagens = [imovel.imagem_url];
  }

  const precoFormatado = new Intl.NumberFormat("pt-BR", {
    style: "currency",
    currency: "BRL",
  }).format(Number(imovel.preco || 0));

  // monta o HTML (template literal limpo)
  conteudo.innerHTML = `
    <div class="container">
      <div class="galeria">
        <button class="prev" type="button">‚ùÆ</button>
        <img id="foto-imovel" src="${imagens[0] || 'images/default.jpg'}" alt="${(imovel.titulo||'Im√≥vel').replace(/"/g, '&quot;')}" />
        <button class="next" type="button">‚ùØ</button>
      </div>

      <div class="content">
        <h1 id="titulo">${imovel.titulo || ""}</h1>
        <p class="subtitulo">${imovel.descricao || ""}</p>

        <div class="info-grid">
          <div><strong>Pre√ßo:</strong><span id="preco">${precoFormatado}</span></div>
          <div><strong>Localiza√ß√£o:</strong><span id="localizacao">${imovel.localizacao || "N√£o informada"}</span></div>
          <div><strong>Metragem:</strong><span id="metragem">${imovel.metragem || "‚Äî"}</span></div>
          <div><strong>Dormit√≥rios:</strong><span id="dormitorios">${imovel.quartos || "‚Äî"}</span></div>
          <div><strong>Banheiros:</strong><span id="banheiros">${imovel.banheiros || "‚Äî"}</span></div>
          <div><strong>Condom√≠nio:</strong><span id="condominio">${imovel.condominio || "‚Äî"}</span></div>
        </div>

        <div class="btns">
          <button onclick="window.history.back()">‚Üê Voltar</button>
          <a id="whatsapp-link" target="_blank">üí¨ Falar no WhatsApp</a>
        </div>
      </div>
    </div>
  `;

  // ajusta link do WhatsApp (agora que template j√° est√° no DOM)
  const wa = document.getElementById("whatsapp-link");
  const mensagem = encodeURIComponent(`Ol√°! Tenho interesse no im√≥vel '${imovel.titulo || ""}'.`);
  wa.href = `https://wa.me/5511943609158?text=${mensagem}`;
  wa.classList.add("whatsapp-btn"); // opcional: para estilo

  // === GALERIA: adiciona navega√ß√£o segura ===
  const imgEl = document.getElementById("foto-imovel");
  const prev = document.querySelector(".galeria .prev");
  const next = document.querySelector(".galeria .next");

  // se n√£o houver imagens, esconde os bot√µes
  if (!imagens || imagens.length === 0) {
    if (prev) prev.style.display = "none";
    if (next) next.style.display = "none";
    return;
  }

  let indice = 0;
  function mostrarIndice(i) {
    indice = ((i % imagens.length) + imagens.length) % imagens.length;
    // troca src com fallback
    imgEl.src = imagens[indice] || "images/default.jpg";
  }

  if (prev) {
    prev.addEventListener("click", () => mostrarIndice(indice - 1));
  }
  if (next) {
    next.addEventListener("click", () => mostrarIndice(indice + 1));
  }

  // permite trocar pela miniatura (se quiser implementar miniaturas)
  // mostrarIndice(0) j√° setou a primeira imagem
  mostrarIndice(0);
}
        carregarDetalhes()
  </script>
</head>
<body class="bg-gray-100 font-sans">
  <div id="conteudo" class="p-4"></div>
</body>
</html>
