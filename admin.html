<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
    <script>
  if (localStorage.getItem("admin-logado") !== "true") {
    alert("Faça login primeiro!");
    window.location.href = "login.html";
  }
</script>
  <title>Painel de cadastro</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="js/supabase.js"></script>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <h1>Painel de Cadastro de Imóveis</h1>

  <form id="formImovel" class="formulario">
    <input type="text" id="titulo" placeholder="Título do imóvel" required />
    <input type="text" id="tipo" placeholder="Tipo (ex: Apartamento)" required />
    <input type="number" id="quartos" placeholder="Quartos" required />
    <input type="number" id="area_m2" placeholder="Área (m²)" required />
    <input type="text" id="bairro" placeholder="Bairro" required />
    <input type="text" id="localizacao" placeholder="Endereco" required />
    <input type="number" id="metragem" placeholder="Metragem" required />
    <input type="number" id="banheiros" placeholder="Banheiros" required />
    <input type="number" id="condominio" placeholder="Condominio" required />
    <input type="text" id="cidade" placeholder="Cidade" required />
    <input type="text" id="estado" placeholder="Estado" required />
    <input type="number" id="preco" placeholder="Preço (R$)" required />
    <textarea id="descricao" placeholder="Descrição"></textarea>
    <button type="submit">Cadastrar Imóvel</button>
  </form>

  <script>
    const form = document.getElementById("formImovel");

 form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const enderecoCompleto = `${form.localizacao.value}, ${form.bairro.value}, ${form.cidade.value}, ${form.estado.value}`;

  // 1️⃣ Converte endereço em coordenadas usando Nominatim (OpenStreetMap)
  let latitude = null;
  let longitude = null;

  try {
    const resp = await fetch(
      `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(enderecoCompleto)}`
    );
    const data = await resp.json();
    if (data && data.length > 0) {
      latitude = parseFloat(data[0].lat);
      longitude = parseFloat(data[0].lon);
    }
  } catch (e) {
    console.warn("Erro ao geocodificar:", e);
  }

  // 2️⃣ Agora envia tudo ao Supabase
  const { error } = await supabase.from("imoveis").insert([
    {
      titulo: form.titulo.value,
      tipo: form.tipo.value,
      quartos: form.quartos.value,
      area_m2: form.area_m2.value,
      bairro: form.bairro.value,
      localizacao: form.localizacao.value,
      metragem: form.metragem.value,
      banheiros: form.banheiros.value,
      condominio: form.condominio.value,
      cidade: form.cidade.value,
      estado: form.estado.value,
      preco: form.preco.value,
      descricao: form.descricao.value,
      latitude,
      longitude,
    },
  ]);

  if (error) {
    alert("❌ Erro ao cadastrar: " + error.message);
  } else {
    alert("✅ Imóvel cadastrado com sucesso!");
    form.reset();
  }
});
    
  </script>
</body>
</html>
