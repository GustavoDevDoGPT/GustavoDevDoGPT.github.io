<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <script>
    // üîê Bloqueia acesso sem login
    if (localStorage.getItem("admin-logado") !== "true") {
      alert("Fa√ßa login primeiro!");
      window.location.href = "login.html";
    }
  </script>
  <title>Brand√£o Im√≥veis - Cadastros</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="js/supabase.js"></script>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <h1>Painel de Cadastro de Im√≥veis</h1>

  <form id="formImovel" class="formulario">
    <input type="text" id="titulo" placeholder="T√≠tulo do im√≥vel" required />
    <input type="text" id="tipo" placeholder="Tipo (ex: Apartamento)" required />

    <select id="disponibilidade">
      <option value="">Alugar e comprar</option>
      <option value="Alugar">Apenas alugar</option>
      <option value="Comprar">Apenas comprar</option>
    </select>

    <input type="number" id="quartos" placeholder="Quartos" required />
    <input type="number" id="area_m2" placeholder="√Årea (m¬≤)" required />
    <input type="text" id="bairro" placeholder="Bairro" required />
    <input type="text" id="localizacao" placeholder="Endere√ßo" required />
    <input type="number" id="metragem" placeholder="Metragem" required />
    <input type="number" id="banheiros" placeholder="Banheiros" required />
    <input type="number" id="condominio" placeholder="Condom√≠nio" required />
    <input type="text" id="cidade" placeholder="Cidade" required />
    <input type="text" id="estado" placeholder="Estado" required />
    <input type="number" id="preco" placeholder="Pre√ßo (R$)" required />
    <textarea id="descricao" placeholder="Descri√ß√£o"></textarea>

    <!-- ‚úÖ NOVO: Upload m√∫ltiplo -->
    <label>Imagens do im√≥vel (pode selecionar v√°rias):</label>
    <input type="file" id="imagens" accept="image/*" multiple required />

    <button type="submit">Cadastrar Im√≥vel</button>
  </form>

  <script>
    const form = document.getElementById("formImovel");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const files = document.getElementById("imagens").files;
      if (files.length === 0) {
        alert("Selecione ao menos uma imagem!");
        return;
      }

      // üó∫Ô∏è Gera endere√ßo completo
      const enderecoCompleto = `${form.localizacao.value}, ${form.bairro.value}, ${form.cidade.value}, ${form.estado.value}`;

      // 1Ô∏è‚É£ Converte endere√ßo em coordenadas
      let latitude = null;
      let longitude = null;
      try {
        const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(enderecoCompleto)}`);
        const data = await resp.json();
        if (data && data.length > 0) {
          latitude = parseFloat(data[0].lat);
          longitude = parseFloat(data[0].lon);
        }
      } catch (e) {
        console.warn("Erro ao geocodificar:", e);
      }

      // 2Ô∏è‚É£ Faz upload de todas as imagens
      const urlsImagens = [];
      for (const file of files) {
        const nomeArquivo = `${Date.now()}-${file.name}`;
        const { data: uploadData, error: uploadError } = await supabase.storage
          .from("imagens-imoveis") // üîÅ nome do bucket
          .upload(nomeArquivo, file);

        if (uploadError) {
          console.error("Erro ao enviar imagem:", uploadError.message);
          alert("‚ùå Erro ao enviar uma imagem: " + uploadError.message);
          return;
        }

        // Pega a URL p√∫blica
        const { data: publicUrlData } = supabase.storage
          .from("imagens-imoveis")
          .getPublicUrl(nomeArquivo);

        urlsImagens.push(publicUrlData.publicUrl);
      }

      // 3Ô∏è‚É£ Define imagem principal (primeira)
      const imagemPrincipal = urlsImagens[0] || null;

      // 4Ô∏è‚É£ Envia os dados ao Supabase
      const { error } = await supabase.from("imoveis").insert([
        {
          titulo: form.titulo.value,
          tipo: form.tipo.value,
          disponibilidade: form.disponibilidade.value,
          quartos: form.quartos.value,
          area_m2: form.area_m2.value,
          bairro: form.bairro.value,
          localizacao: form.localizacao.value,
          metragem: form.metragem.value,
          banheiros: form.banheiros.value,
          condominio: form.condominio.value,
          cidade: form.cidade.value,
          estado: form.estado.value,
          preco: form.preco.value,
          descricao: form.descricao.value,
          imagem_url: imagemPrincipal,
          imagens: urlsImagens, // ‚úÖ salva todas as imagens no JSON
          latitude,
          longitude,
        },
      ]);

      if (error) {
        alert("‚ùå Erro ao cadastrar: " + error.message);
      } else {
        alert("‚úÖ Im√≥vel cadastrado com sucesso!");
        form.reset();
      }
    });
  </script>
</body>
</html>
